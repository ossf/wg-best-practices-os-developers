<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://best.openssf.org/assets/css/style.css">
<link rel="stylesheet" href="checker.css">
<script src="js-yaml.min.js"></script>
<script src="checker.js"></script>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

<!-- See create_labs.md for how to create your own lab! -->

<!-- Sample expected answer -->
<script id="expected0" type="plain/text">
  clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
</script>
<!--
-->
<script id="expected1" type="plain/text">
  subprocess.run(["ls", "-l", clean_dir])
</script>

<!-- Full pattern of correct answer -->
<script id="correct0" type="plain/text">
\s*
  clean_dir = re . sub \( r'\[\^a-zA-Z0-9\]' , r?(''|"") , dir_to_list \)
\s*
</script>
<script id="correct1" type="plain/text">
\s*
  subprocess . run \( \[ ('ls'|"ls") , ('-l'|"-l") , clean_dir \] \)
\s*
</script>

<script id="info" type="application/yaml">
---
hints:
- absent: |-
    re \. sub
  text: >
    Use re.sub(OLDPATTERN, REPLACEPATTERN, dir_to_list) to
    remove anything that is not an alphanumeric character (removing the rest).
  examples:
  -
    - clean_dir = dir_to_list
    - subprocess.run(f"ls -l {dir_to_list}", shell=True)
- absent: |-
    re \. sub \( r
  text: >
    Python re.sub uses strings to indicate a regex pattern.
    By convention these strings usually 'raw' strings, so they
    have the form r'PATTERN'. So you should have something like
    re.sub( r'...' ...).
- absent: |-
    re \. sub \( r\'
  text: >
    Python re.sub uses strings to indicate a regex pattern.
    By convention these strings usually 'raw' strings, so they
    have the form r'PATTERN'. You have the "r" but not the following
    single quote character (we will use single quotes here).
- absent: |-
    re \. sub \( r\'\[
  text: >
    Use re.sub(r'[...]', ...) to
    indicate that you want to replace every character matching a
    certain pattern.
  examples:
  -
    - clean_dir = re.sub(r'', '', dir_to_list)
    - subprocess.run(f"ls -l {dir_to_list}", shell=True)
- absent: |-
    re \. sub \( r\'\[\^
  text: >
    Use re.sub(r'[^ALPHANUMERIC_PATTERN]', '', dir_to_list) to
    indicate that you want to replace everything that is not
    an alphanumeric character. Be sure to replace ALPHANUMERIC_PATTERN
    with a regular expression pattern that describes alphanumerics!
  examples:
  -
    - clean_dir = re.sub(r'[a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run(f"ls -l {dir_to_list}", shell=True)
- absent: "subprocess.run"
  index: 1
  text: Use subprocess.run
- present: |-
    shell = [Tt]rue
  index: 1
  text: |-
    Don't say `shell = True`; we don't want to unnecessarily run the shell.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run(f"ls -l {dir_to_list}", shell=True)
- present: |-
    f["']ls\s+-l
  index: 1
  text: >-
    You should generally avoid using string concatenation when creating
    a command to execute. Formatted strings like f"..." are a form of
    string concatenation. In addition, you MUST avoid string concatenation
    in this case. The shell uses spaces to separate arguments, but we're
    trying to avoid using the shell when it's not needed.
    You must instead provide the arguments as a list with
    separate parameters, e.g.,
    subprocess.run(["ls", "-l", clean_dir]) or similar.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run(f"ls -l {dir_to_list}")
- present: |-
    ["']ls\s+-l
  index: 1
  text: >-
    The shell uses spaces to separate arguments, but we're
    trying to avoid using the shell when it's not needed.
    You must instead provide the arguments as a list with
    separate parameters, e.g.,
    subprocess.run(["ls", "-l", clean_dir]) or similar.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run("ls -l {dir_to_list}")
- present: |-
    subprocess \. run \( [A-Za-z0-9"']
  index: 1
  text: >-
    The `subprocess.run` function takes a LIST of parameters as its command.
    This has the form `subprocess.run([P1, P2, ...])`. Use
    subprocess.run(["ls", "-l", clean_dir]) or similar.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run("ls", "-l", clean_dir)
- present: |-
    \{(dir_to_list|clean_dir)\}
  index: 1
  text: >-
    You don't need {...} in your result. Use
    subprocess.run(["ls", "-l", clean_dir]) or similar.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run(["ls", "-l", {dir_to_list}])
- present: |-
    dir_to_list
  index: 1
  text: >-
    The parameter `dir_to_list` is what was provided, but you don't want
    to use that. You want to use the cleaned value `clean_dir` instead. Use
    subprocess.run(["ls", "-l", clean_dir]) or similar.
  examples:
  -
    - clean_dir = re.sub(r'[^a-zA-Z0-9]', '', dir_to_list)
    - subprocess.run(["ls", "-l", dir_to_list])
definitions:
</script>
</head>
<body>
<!-- For GitHub Pages formatting: -->
<div class="container-lg px-3 my-5 markdown-body">
<h1>Lab Exercise shell-injection</h1>
<p>
This is a lab exercise on developing secure software.
For more information, see the <a href="introduction.html" target="_blank">introduction to
the labs</a>.

<p>
<h2>Task</h2>
<p>
<b>Eliminate a shell injection vulnerability.</b>

<p>
<h2>Background</h2>
<p>
In many cases, programmers run system commands from their applications.
This happens for multiple reasons: running a complicated tool, avoiding to
code a functionality that exists in another tool,
or just because the application
(often a web application) is an interface to a tool running
on the server system.
Doing this incorrectly, however, can lead to vulnerabilities.
</p>

<p>
Quite often the list of parameters of that external tool isn't static.
One or multiple parameters are given by an untrusted end user.
This may be the name
they give to the project, for example.
The application needs to avoid passing these parameters through the shell
at all if the shell isn't needed.
</p>

<p>
In addition,
the application need to carefully handle
the given parameters to make sure they do not contain special characters like
the end of the command (often ';'). Otherwise, an attacker might be
able to craft input
in such a way that they execute commands of their choice in addition to the
one present in the application.
We need to do that with an allowlist, that is, by expressly listing what
is allowed (and forbidding everything else).
</p>

<p>
<h2>Task Information</h2>
<p>
In this task we are going to fix a shell command injection situation. You may
want to test the result of different user input separately to see what happens.
</p>

<p>
Our scenario is a simple one. In our application in Python, we want to list
files in a temporary directory used by our application for data processing.
The original code was:
</p>

<pre><code>  subprocess.run("ls -l", shell=True)</code></pre>

<p>
Then, another developer added user input for the directory with the raw user
data in the variable <tt>dir_to_list</tt> as follows:
</p>

<pre><code>def list_directory(dir_to_list):
    subprocess.run(f"ls -l {dir_to_list}", shell=True)
</pre></code>

<p>
This is a shell injection vulnerability.
An attacker can put arbitrary text into the parameter, which will be
executed by the shell.
It would safer to ensure
that only safe characters would be considered, <i>and</i> to
<i>not</i> invoke the shell at all.
By taking both steps, we make it much harder for an attacker
to find a way to work around it.
</p>

<p>
We can offer a few hints.
You'll need to modify a string to only contain alphanumerics.
Python's <tt>re.sub(OLDPATTERN, REPLACEPATTERN, ORIGINAL_VALUE)</tt>
returns the result of replacing <tt>OLDPATTERN</tt> with
<tt>REPLACEPATTERN</tt> in <tt>ORIGINAL_VALUE</tt>, where <tt>OLDPATTERN</tt>
is a regular expression. In Python regular expressions are usually expressed
using the "raw" string form, that is, using the <tt>r'...'</tt> syntax.
You need to stop invoking the shell in Python's
<tt>subprocess.run</tt>, including separating the arguments.
</p>

<p>
To be fair, a typical Python program wouldn't call "ls" directly.
We'll do that to keep the example simple, since there are times when
you need to invoke a shell.
</p>

<p>
<h2>Interactive Lab (<span id="grade"></span>)</h2>
<p>
Rewrite the following function to be safe:
<p>
<form id="lab">
<pre><code>def list_directory(dir_to_list):
  # Modify the directory so it only contains a-zA-Z0-9
<textarea id="attempt0" rows="2" cols="60" spellcheck="false">
  clean_dir = dir_to_list
</textarea>
  # Then use subprocess in a safer way
<textarea id="attempt1" rows="2" cols="60" spellcheck="false">
  subprocess.run(f"ls -l {dir_to_list}", shell=True)
</textarea>
</code></pre>
<button type="button" class="hintButton">Hint</button>
<button type="button" class="resetButton">Reset</button>
<button type="button" class="giveUpButton">Give up</button>
<br><br>
<p>
<i>This lab was developed by Marta Rybczynska.</i>
<br><br>
<p>
<p id="correctStamp" class="small">
<textarea id="debugData" class="displayNone" rows="20" cols="65" readonly>
</textarea>
</form>
</div><!-- End GitHub pages formatting -->
</body>
</html>
